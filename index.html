<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Collision-map-maker</title>
</head>

<body>
    <div id = "control_buttons" 
        style = "position: fixed; right: 0; top: 50; z-index: 1000; display: flex; flex-direction: column; border: 2px solid red;"
        >
        <input type="file" onchange='loadFront(event)'/>
    
        <label for="opacity_range">Opacity:</label>
        <input type="range" min="0" max="100" value="1" onchange="changeBackOpacity(event)" step="10"
            name = 'opacity_range' id = 'opacity_range' style = "max-width: 150px;"
        >
        <label for="brush_width">Brush width:</label>
        <input type="range" min="0" max="100" value="1" onchange="changeBrushWidth(event)" step="10"
            name = 'brush_width' id = 'brush_width' style = "max-width: 150px;"
        >
        <button id = 'download_btn'>Download</button>
    </div>

    <div id="container" style = "border: 2px solid red; position: relative">
        
    </div>
    
</body>
    <script src="https://unpkg.com/konva@8/konva.min.js"></script>
    <script>
        let stage = null, layer = null, front = null, back = {canvas: null, ctx: null, image: null}
        let isPaint = false, mode = 'brush'
        let opacity_range = document.getElementById('opacity_range'), brush_width = document.getElementById('brush_width')

        function loadFront (e) {
            const input = e.target
            if (!input.files.length) return

            const reader = new FileReader()

            reader.onload = () => {
                const dataURL = reader.result
                initStage(dataURL)
            }

            reader.readAsDataURL(input.files[0])
        }

        function initStage (dataURL) {
            stage = new Konva.Stage({
                container: 'container',
                width: window.innerWidth,
                height: window.innerHeight,
            })
        
            layer = new Konva.Layer()
            stage.add(layer)

            setFrontImage(dataURL)
        }

        function setFrontImage (dataURL) {
            const image = new Image()
            image.onload = () => {
                front = new Konva.Image({ image })
                layer.add(front)

                stage.setAttrs({width: image.width, height: image.height})
                setBackImage()
            }
            image.src = dataURL
        }

        function setBackImage () {
            back.canvas = document.createElement('canvas')
            back.canvas.width = stage.width()
            back.canvas.height = stage.height()
            back.canvas.style.position = 'absolute'
            back.canvas.style.top = '0px'
            back.canvas.style.zIndex = -1
            document.getElementById('container').appendChild(back.canvas)

            back.ctx = back.canvas.getContext("2d")
            back.ctx.fillStyle = "white"
            back.ctx.fillRect(0, 0, back.canvas.width, back.canvas.height)
            back.ctx.strokeStyle = '#000000'
            back.ctx.lineJoin = 'round'
            back.ctx.lineWidth = 10
            
            opacity_range.value = 50

            stage.setAttr('opacity', opacity_range.value / 100)

            back.image = new Konva.Image({ image: back.canvas, opacity: 0 })
            layer.add(back.image)

            drawing()
        }

        function changeBackOpacity (e) {
            if (stage) stage.setAttr('opacity', opacity_range.value / 100)
        }
        function changeBrushWidth (e) {
            if (back.ctx) back.ctx.lineWidth = e.target.value
        }

        function drawing () {

            let lastPointerPosition = null

            back.image.on('mousedown touchstart', function () {
                isPaint = true
                lastPointerPosition = stage.getPointerPosition()
            })

            stage.on('mouseup touchend', function () {
                isPaint = false
            })

            stage.on('mousemove touchmove', function () {
                if (!isPaint) return

                if (mode === 'brush') back.ctx.globalCompositeOperation = 'source-over'
                if (mode === 'eraser') back.ctx.globalCompositeOperation = 'destination-out'

                back.ctx.beginPath()

                let localPos = {
                    x: lastPointerPosition.x - back.image.x(),
                    y: lastPointerPosition.y - back.image.y(),
                }
                back.ctx.moveTo(localPos.x, localPos.y)
                let pos = stage.getPointerPosition()
                localPos = {
                    x: pos.x - back.image.x(),
                    y: pos.y - back.image.y(),
                }
                back.ctx.lineTo(localPos.x, localPos.y)
                back.ctx.closePath()
                back.ctx.stroke()

                lastPointerPosition = pos
            })
        }
        
        function downloadURI(uri, name) {
            const link = document.createElement('a')
            link.download = name
            link.href = uri
            document.body.appendChild(link)
            link.click()
            document.body.removeChild(link)
            delete link
        }

        document.getElementById('download_btn').addEventListener('click', () => {
            if (!back.canvas) return
            const dataURL = back.canvas.toDataURL()
            downloadURI(dataURL, 'collision_map.png')
        })

      </script>
</html>